name: Render Video

on:
  workflow_dispatch:
    inputs:
      quality:
        description: 'Video quality'
        required: true
        default: '1080p'
        type: choice
        options:
          - '1080p'
          - '720p'
          - '4k'

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: video/package-lock.json

      - name: Install dependencies
        working-directory: ./video
        run: npm ci

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Render video (1080p)
        if: ${{ github.event.inputs.quality == '1080p' }}
        working-directory: ./video
        run: npx remotion render Video out/groq-rag-video-1080p.mp4 --gl=angle

      - name: Render video (720p)
        if: ${{ github.event.inputs.quality == '720p' }}
        working-directory: ./video
        run: npx remotion render Video out/groq-rag-video-720p.mp4 --height=720 --width=1280 --gl=angle

      - name: Render video (4K)
        if: ${{ github.event.inputs.quality == '4k' }}
        working-directory: ./video
        run: npx remotion render Video out/groq-rag-video-4k.mp4 --height=2160 --width=3840 --gl=angle

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: groq-rag-video-${{ github.event.inputs.quality }}
          path: video/out/*.mp4
          retention-days: 30

      - name: Get video info
        working-directory: ./video
        run: |
          echo "Video rendered successfully!"
          ls -lh out/
          ffprobe -v quiet -print_format json -show_format out/*.mp4 | head -20
